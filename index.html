<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia at 2014-03-24
 | Rendered using Apache Maven Fluido Skin 1.3.0
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="author" content="Zoltan Farkas" />
    <meta name="Date-Creation-yyyymmdd" content="20130512" />
    <meta name="Date-Revision-yyyymmdd" content="20140324" />
    <meta http-equiv="Content-Language" content="en" />
    <title>spf4j - Spf4j (Simple performance framework for java)</title>
    <link rel="stylesheet" href="./css/apache-maven-fluido-1.3.0.min.css" />
    <link rel="stylesheet" href="./css/site.css" />
    <link rel="stylesheet" href="./css/print.css" media="print" />

      
    <script type="text/javascript" src="./js/apache-maven-fluido-1.3.0.min.js"></script>

    
            </head>
        <body class="topBarDisabled">
          
                
                    
    
        <div class="container-fluid">
          <div id="banner">
        <div class="pull-left">
                                <div id="bannerLeft">
                <h2>SPF4J</h2>
                </div>
                      </div>
        <div class="pull-right">  </div>
        <div class="clear"><hr/></div>
      </div>

      <div id="breadcrumbs">
        <ul class="breadcrumb">
                
                    
                  <li id="publishDate">Last Published: 2014-03-24</li>
                  <li class="divider">|</li> <li id="projectVersion">Version: 6.5.5</li>
                      
                
                    
      
                                              
    <li class="pull-right">              <a href="./" title="SPF4J">
        SPF4J</a>
  </li>

                        </ul>
      </div>

            
      <div class="row-fluid">
        <div id="leftColumn" class="span3">
          <div class="well sidebar-nav">
                
                    
                <ul class="nav nav-list">
                    <li class="nav-header">Main Menu</li>
                                
      <li class="active">
    
            <a href="#"><i class="none"></i>Introduction</a>
          </li>
                  
      <li>
    
                          <a href="http://code.google.com/p/spf4j/downloads/list" class="externalLink" title="Download">
          <i class="none"></i>
        Download</a>
            </li>
                              <li class="nav-header">Modules</li>
                                
      <li>
    
                          <a href="spf4j-core/index.html" title="spf4j-core">
          <i class="none"></i>
        spf4j-core</a>
            </li>
                  
      <li>
    
                          <a href="spf4j-ui/index.html" title="spf4j-ui">
          <i class="none"></i>
        spf4j-ui</a>
            </li>
                  
      <li>
    
                          <a href="spf4j-aspects/index.html" title="spf4j-aspects">
          <i class="none"></i>
        spf4j-aspects</a>
            </li>
                  
      <li>
    
                          <a href="spf4j-zel/index.html" title="spf4j-zel">
          <i class="none"></i>
        spf4j-zel</a>
            </li>
                              <li class="nav-header">Project Documentation</li>
                                                                                                                                                                                                                                                                                                                                                        
      <li>
    
                          <a href="project-info.html" title="Project Information">
          <i class="icon-chevron-down"></i>
        Project Information</a>
                    <ul class="nav nav-list">
                      
      <li class="active">
    
            <a href="#"><i class="none"></i>About</a>
          </li>
                      
      <li>
    
                          <a href="team-list.html" title="Project Team">
          <i class="none"></i>
        Project Team</a>
            </li>
                      
      <li>
    
                          <a href="modules.html" title="Project Modules">
          <i class="none"></i>
        Project Modules</a>
            </li>
                      
      <li>
    
                          <a href="dependency-info.html" title="Dependency Information">
          <i class="none"></i>
        Dependency Information</a>
            </li>
                      
      <li>
    
                          <a href="plugins.html" title="Project Plugins">
          <i class="none"></i>
        Project Plugins</a>
            </li>
                      
      <li>
    
                          <a href="integration.html" title="Continuous Integration">
          <i class="none"></i>
        Continuous Integration</a>
            </li>
                      
      <li>
    
                          <a href="issue-tracking.html" title="Issue Tracking">
          <i class="none"></i>
        Issue Tracking</a>
            </li>
                      
      <li>
    
                          <a href="source-repository.html" title="Source Repository">
          <i class="none"></i>
        Source Repository</a>
            </li>
                      
      <li>
    
                          <a href="dependency-convergence.html" title="Dependency Convergence">
          <i class="none"></i>
        Dependency Convergence</a>
            </li>
                      
      <li>
    
                          <a href="license.html" title="Project License">
          <i class="none"></i>
        Project License</a>
            </li>
                      
      <li>
    
                          <a href="plugin-management.html" title="Plugin Management">
          <i class="none"></i>
        Plugin Management</a>
            </li>
                      
      <li>
    
                          <a href="distribution-management.html" title="Distribution Management">
          <i class="none"></i>
        Distribution Management</a>
            </li>
                      
      <li>
    
                          <a href="project-summary.html" title="Project Summary">
          <i class="none"></i>
        Project Summary</a>
            </li>
                      
      <li>
    
                          <a href="mail-lists.html" title="Mailing Lists">
          <i class="none"></i>
        Mailing Lists</a>
            </li>
                      
      <li>
    
                          <a href="dependencies.html" title="Dependencies">
          <i class="none"></i>
        Dependencies</a>
            </li>
              </ul>
        </li>
            </ul>
                
                    
                            <form id="search-form" action="http://www.google.com/search" method="get" >
    
  <input value="$sitesearchValue" name="sitesearch" type="hidden"/>
  <input class="search-query" name="q" id="query" type="text" />
</form>
<script type="text/javascript" src="http://www.google.com/coop/cse/brand?form=search-form"></script>
          
          <hr class="divider" />

           <div id="poweredBy">
                   
    <script type="text/javascript" src="https://apis.google.com/js/plusone.js"></script>

    
    <div class="g-plusone" data-href="http://www.spf4j.org" data-size="tall" ></div>

                   <div class="clear"></div>
                   
        
        
        
    <iframe src="http://www.facebook.com/plugins/like.php?href=http://www.spf4j.org&send=false&layout=box_count&show-faces=false&action=like&colorscheme=light"
        scrolling="no" frameborder="0"
        style="border:none; width:48px; height:63px; margin-top: 10px;" ></iframe>
               <div class="clear"></div>
                            <div class="clear"></div>
                             <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy">
        <img class="builtBy" alt="Built by Maven" src="./images/logos/maven-feather.png" />
      </a>
                  </div>
          </div>
        </div>
        
                
        <div id="bodyColumn"  class="span9" >
                                  
            <div class="section">
<h2>1. Overview<a name="a1._Overview"></a></h2>
<p>The spf4j library is a collection of utilities and components to monitor, troubleshoot and fix performance issues. This library also contains useful general purpose utilities and components that are currently not available in high quality form in other OS libraries (Retry utils, object pool...) This library also contains ZEL, a simple expression language that can be easily used in any java application. Zel is easy to extend to your needs and also has some cool features like async functions, memorization... You can learn more by checking out the <a class="externalLink" href="http://www.spf4j.org/spf4j-zel/index.html">spf4j-zel</a> module.</p></div>
<div class="section">
<h2>2. License<a name="a2._License"></a></h2>
<p>This library is LGPL licensed: <a class="externalLink" href="http://www.gnu.org/licenses/lgpl.html">License</a></p>
<p>Contributions/Contributors to spf4j are welcome.</p></div>
<div class="section">
<h2>3. Code and Binaries<a name="a3._Code_and_Binaries"></a></h2>
<p><a class="externalLink" href="http://code.google.com/p/spf4j/">SPF4J Google hosted repo</a></p>
<p><a class="externalLink" href="https://github.com/zolyfarkas/spf4j/">SPF4J Github hosted repo</a></p>
<p><a class="externalLink" href="http://www.zoltran.com/maven2/">Maven repo</a></p></div>
<div class="section">
<h2>4. Performance monitoring<a name="a4._Performance_monitoring"></a></h2>
<div class="section">
<h3>4.1. Why not use jamon, netflix servo ?<a name="a4.1._Why_not_use_jamon_netflix_servo_"></a></h3>
<p>Observing a system changes the system. The goal of this library is to minimize the observer effect. The code in spf4j is carefully written to be as high performance as possible, it should outperform all competing libraries on any modern JVM(implementing biased locking) running on a CCNUMA system. </p></div>
<div class="section">
<h3>4.2. How to record measurements?<a name="a4.2._How_to_record_measurements"></a></h3>
<div class="section">
<h4>4.2.1 Via API<a name="a4.2.1_Via_API"></a></h4>
<ul>
<li>Low impact with log linear quantized recording for Gauge type of measurements:
<div class="source">
<pre>private static final MeasurementRecorder recorder 
                     = RecorderFactory.createScalableQuantizedRecorder(forWhat, unitOfMeasurement,
                     sampleTime, factor, lowerMagnitude, higherMagnitude, quantasPerMagnitude);
&#x2026;
recorder.record(measurement);</pre></div>
<p>This is ideal for recording execution times and provides the most detail. (Min, max, avg, and detailed distribution heat chart) If distribution chart is not needed createScalableMinMaxAvgRecorder is available with less overhead.</p></li>
<li>Low impact with simple counting for Counters.
<div class="source">
<pre>private static final MeasurementRecorder recorder 
                     = RecorderFactory.createScalableCountingRecorder(forWhat, unitOfMeasurement, sampleTimeMillis);
&#x2026;
recorder.record(measurement);</pre></div>
<p>This is ideal for measurements like bytesSent, bytesReceived.</p></li>
<li>Dynamic with log linear quantized recording for Gauge type of measurements.
<div class="source">
<pre>private static final MeasurementRecorderSource recorderSource
                    = RecorderFactory.createScalableQuantizedRecorderSource( forWhatCategory, unitOfMeasurement,
                      sampleTime, factor, lowerMagnitude, higherMagnitude, quantasPerMagnitude);
&#x2026;
recorderSource.getRecorder(forWhat).record(measurement)</pre></div>
<p>As with the low impact static recorders there are dynamic equivalents: createScalableMinMaxAvgRecorderSource and createScalableCountingRecorderSource</p></li></ul>
<p>You can also create a monitored callable and call it of pass it to a executor like :</p>
<div class="source">
<pre>Callable&lt;?&gt; monitoredCallable = 
     performanceMonitoredCallable(recorderSource, warnMillis, errorMillis, callable, &quot;myCallable&quot;).call()</pre></div></div>
<div class="section">
<h4>4.2.2 Via Annotations<a name="a4.2.2_Via_Annotations"></a></h4>
<p>Annotate a method you want to measure and monitor performance with the annotation:</p>
<div class="source">
<pre>@PerformanceMonitor(warnThresholdMillis=1, errorThresholdMillis=100, recorderSource = RecorderSourceInstance.Rs5m.class)</pre></div>
<p>Start your jvm with Aspectj load time weaver:</p>
<div class="source">
<pre>-javaagent:${project.build.directory}/lib/aspectjweaver-${aspectj.version}.jar</pre></div>
<p>Make sure your aspectj config file (META-INF/aop.xml) contains:</p>
<div class="source">
<pre>&lt;aspectj&gt;
&lt;aspects&gt;
&lt;aspect name=&quot;org.spf4j.perf.aspects.PerformanceMonitorAspect&quot;/&gt;
&lt;/aspects&gt;
&lt;weaver options=&quot;-verbose&quot;&gt;
&lt;include within=&quot;com.*..*&quot;/&gt;
&lt;/weaver&gt;
&lt;/aspectj&gt;</pre></div>
<p>This will record the execution times of the annotated method, and will also log (via spf4j) a message containing the call detail and execution time if the warn or error thresholds are exceeded. Dynamic quantized recorder source is used.</p></div></div>
<div class="section">
<h3>4.3. How to see the recorded measurements?<a name="a4.3._How_to_see_the_recorded_measurements"></a></h3>
<div class="section">
<h4>Via JMX <a name="Via_JMX"></a></h4>
<p>invoke spf4j/RRDMeasurementDatabase/generateCharts, this will generate 2 charts that will contain the recorded measurements:</p>
<div class="section">
<h5>a) min, max, avg <a name="a_min_max_avg"></a></h5><img src="images/spf4j_min_max_avg.png" alt="sample min, max, avg performance chart with measurement count values/ time axis" /></div>
<div class="section">
<h5>b) Distribution chart, <a name="b_Distribution_chart"></a></h5><img src="images/spf4j_dist.png" alt="sample distribution chart" />
<p>where on the X axis we have the time, the Y axis we have the recorded values (buckets) and the number of measurements recorded that fall in a particular bucket will be represented by the color (values to color mapping can be seen in the legend). As you can see this is a log linear chart. </p></div></div>
<div class="section">
<h4>Embeded UI.<a name="Embeded_UI."></a></h4>
<p>The recorded measurements are saved to a TSDB file. Use the library provided UI to open the file and visualize the measurements.</p><img src="images/explorer-ui.png" alt="" /></div></div>
<div class="section">
<h3>4.4. How does it work ?<a name="a4.4._How_does_it_work_"></a></h3>
<p>Measurements are recorded and stored in the Thread local storage. At scheduled intervals the measurements aare retrieved, aggregated and stored to a TSDB file. Charts are generated using jfreechart library. TSDB file can also be opened and measurements viewed with the library embeded UI.</p>
<div class="source">
<pre>
[Code context] ---record(value)---&gt; [Thread Local Storage] ----&gt; [Aggregator/Persister] -----&gt; [TSDB]
</pre></div></div></div>
<div class="section">
<h2>5.Performance Profiling<a name="a5.Performance_Profiling"></a></h2>
<div class="section">
<h3>5.1. Why another profiling library?<a name="a5.1._Why_another_profiling_library"></a></h3>
<p>It all started with Brendan Gregg's blog: http://dtrace.org/blogs/brendan/2011/12/16/flame-graphs/ combined with a few hours of coding. However since than more monitoring capability has been added to spf4j. Flame-graph visualization has been improved to better see hot function calls... Aspects to monitor object allocation, network, file, memory, garbage collection usage have been added. One of the main advantages of spf4j is that it can be easily be used for continuous profiling. The captured profile data is persisted to ssdump files which can be opened and visualized with the spf4j UI. </p></div>
<div class="section">
<h3>5.2. When to profile your code?<a name="a5.2._When_to_profile_your_code"></a></h3>
<p>I recommend to deploy your code with profiling turned on as much as you can. In my case I have profiling data collection turned on in test/qa environments all the time. (with 100ms sampling interval). If you can afford to do it in PROD do it.</p></div>
<div class="section">
<h3>5.3. How to profile your code?<a name="a5.3._How_to_profile_your_code"></a></h3>
<p>Add spf4j to your classpath and the following to your command line:</p>
<div class="source">
<pre>${JAVA_HOME}/bin/java [your jvm args] org.spf4j.stackmonitor.Monitor -f reportFile.html -ss -si 100 -w 600 -main [your app main class] -- [your app arguments]</pre></div>
<p>This will start your application with profiling enabled, with a 100 ms sampling interval. After the process ends reportFile.html will be generated with a graphic width of 600 pixels. Profiling can also be enabled/disabled via JMX.</p>
<p>Supported arguments:</p>
<div>
<pre>Usage:
 -di N     : the stack dump to file interval in milliseconds
 -f VAL    : output to this file the perf report, format is HTML
 -main VAL : the main class name
 -md N     : maximum stack trace depth
 -nosvg    : stack visualization will be in svg format
 -si N     : the stack sampling interval in milliseconds
 -ss       : start the stack sampling thread. (can also be done manually via
             jmx)
 -w N      : flame chart width in pixels</pre></div></div>
<div class="section">
<h3>5.4. How to see the profile data?<a name="a5.4._How_to_see_the_profile_data"></a></h3>
<p>After the program finishes it will write the data to the <a href="./stackSample.html">stackSample.html</a> file</p>
<p>If you have a server application running and you started it with stack sampling, by default every 1 hour the collected stack data is dumped to the temp folder. You can also invoke Sampler.dumpToFile to dum the stack samples at any time in your program allowing you to separate out samples at relevant times in your application. You can load and visualize this data with the library embeded ui:</p><img src="images/spf4j-flame-graph.png" alt="" />
<p>The classic flame graph visualization remains available. The explorer ui can be used to visualize the measurements stored in the tsdb files. You can also export the measurements to csv format allowing you to analyze them with tools like excel.</p><img src="images/explorer-ui.png" alt="" />
<p>in the UI you can filter certain stack traces by right clicking on them and using the filter option in the context menu.</p></div>
<div class="section">
<h3>5.5. How does it work?<a name="a5.5._How_does_it_work"></a></h3>
<p>A sampling thread is started and running in the background. This thread uses Thread.getAllStackTraces() or the JVM MX beans (configurable) to get all stack traces for all threads. Each sample is added to a tree that aggregates the stack trace data.</p></div>
<div class="section">
<h3>5.6. Monitoring memory allocations:<a name="a5.6._Monitoring_memory_allocations:"></a></h3>
<p>You will need to apply aspect org.spf4j.memorymonitor.AllocationMonitorAspect to the code you want to monitor object allocations. This aspect will intercept all new objects calls in your code and it will use performance monitoring described at chapter 4 to record the number and amount of allocations. AspectJ load time weaving is not capable of intercepting allocations done inside rt.jar. You will have to apply your aspect against rt.jar and create a new one and add it to the boot class path in case you want to see all allocations.</p>
<p>Getting access to the data is same as described in chapter 4, you can do it over jmx, or opening the tsdb file in the embeded ui:</p><img src="images/spf4j_allocations.png" alt="" />
<p>Allocations are classified based on the class where they are done. This allows you to quickly identify memory hogs. In the chart above you can see how memory allocations happened, both byteSize and allocation count and what class. Object size computation might be too much overhead, in that case you can disable it by system property setting:</p>
<div class="source">
<pre>-Dperf.allocations.recordSize=false</pre></div></div>
<div class="section">
<h3>5.7. Monitoring Network IO<a name="a5.7._Monitoring_Network_IO"></a></h3>
<p>The aspect org.spf4j.iomonitor.NetworkMonitorAspect will allow you to monitor you processes network traffic.</p><img src="images/spf4j_io.png" alt="network traffic" /></div>
<div class="section">
<h3>5.8. Monitoring Memory Usage<a name="a5.8._Monitoring_Memory_Usage"></a></h3>
<p>By calling MemoryUsageSampler.startMemoryUsageSampling(sampleTime) memory usage will be sampled at the provided interval. Sampled data ill be aggregated at the interval set by perf.memory.sampleAggMillis system property. Data will be stored into a spf4j tsdb where data can be accessed via jmx or the sf4j ui.</p></div>
<div class="section">
<h3>5.9. Monitoring File Usage<a name="a5.9._Monitoring_File_Usage"></a></h3>
<p>By calling OpenFilesSampler.startFileUsageSampling(sampleTime, warnThreshold, errorThreshold), file usage will be sampled at the provided interval. This is usefull to see open files trend and detect file handle leaks, which will cause in general outages of your application. The warn and error threshold numbers will long details provided by lsof to help you troubleshoot what is going on. Sampled data will be aggregated at the interval set by perf.io.openFiles.sampleAggMillis system property. Data will be stored into a spf4j tsdb where data can be accessed via jmx or the sf4j ui.</p></div></div>
<div class="section">
<h2>6. High Performance Object Pool<a name="a6._High_Performance_Object_Pool"></a></h2>
<div class="section">
<h3>6.1. Why another object pool implementation?<a name="a6.1._Why_another_object_pool_implementation"></a></h3>
<p>In my(I am not alone) view current available object pool implementations are less than perfect. Beside the scalability issues and bugs, I don't like the following implementation choices found in other implementations:</p>
<ul>
<li>1. Test on borrow is pointless, there is no guarantee that you will get a valid object even if you test on borrow. This encourages the developer to disregard handling of this case when it receives an invalid object. This practice also often is a performance killer.</li>
<li>2. Indiscriminate test on return is not optimal. Test on return should be done only in the case where there is a suspicion that the object is invalid, otherwise the performance impact will be too high to be acceptable in most cases. Pool client should be able to provide feedback on return for that case.</li>
<li>3. NO exception swallowing. If a exception happens with the pooled objects the pool user will know about it and will have to handle it.</li></ul>
<p>One of the most popular object pool implementations is apache commons-pool with dbcp-pool specialized in JDBC object based on it. A lot of people are unhappy with this implementation (including myself), so much that the apache tomcat developers wrote their own implementation. Here is a comparison of their implementation against dbcp pool:</p>
<p>http://tomcat.apache.org/tomcat-7.0-doc/jdbc-pool.html</p>
<p>A performance comparison between dbcp, c3p0, and tomcat jdbc pool :</p>
<p>http://www.tomcatexpert.com/blog/2010/03/22/understanding-jdbc-pool-performance-improvements</p>
<p>The goal of this implementation is to be more reliable and faster than any of the implementations out there.</p></div>
<div class="section">
<h3>6.2. Use case<a name="a6.2._Use_case"></a></h3>
<p>The classical use case for an object pool is to pool your jdbc connections or any type of network connection.</p></div>
<div class="section">
<h3>6.3. How to use the object pool<a name="a6.3._How_to_use_the_object_pool"></a></h3>
<p>Creating a pool is simple:</p>
<div class="source">
<pre>ObjectPool&lt;ExpensiveTestObject&gt; pool = new ObjectPoolBuilder(10, new ExpensiveTestObjectFactory()).build();</pre></div>
<p>at minimum you will need to provide the maximum size and the object factory. To do something with a object from a pool you will need to:</p>
<div class="source">
<pre>Template.doOnPooledObject(new ObjectPool.Hook&lt;PooledObject, SomeException&gt;() {
   @Override
   public void handle( PooledObject object) throws SomeException {
   object.doStuff();
   }
}, pool, IOException.class);</pre></div>
<p>You can also use the borrow and return methods on the object pool to get and return an object to the pool.</p></div>
<div class="section">
<h3>6.4. How does the pool work?<a name="a6.4._How_does_the_pool_work"></a></h3>
<p>The architecture above biases object to threads, so a thread will most likely get the same object minimizing object contention (if pool size &gt;= thread nr which is the recommended sizing). </p>
<div class="source">
<pre>      [code context]  &lt;----&gt; [Thread Local Pool] &lt;----&gt; [Global Pool]                                                       </pre></div>
<p>On the other hand this pool implementation will prefer to create a new connection instead of reusing a connection that has already has been used by another thread. This is alleviated by the maintenance process which can bring back unused local object to the global pool.</p></div></div>
                  </div>
            </div>
          </div>

    <hr/>

    <footer>
            <div class="container-fluid">
              <div class="row span12">Copyright &copy;                   2014.
          All Rights Reserved.      
                    
      </div>

        
        
                </div>
    </footer>
  </body>
</html>
